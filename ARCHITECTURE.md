# ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹

## ğŸ“ ĞĞ±Ñ‰Ğ°Ñ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°

Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° Ğ¿Ğ¾ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ° Ğ¿Ğ¾ Ñ‚Ñ€Ñ‘Ñ…Ğ·Ğ²ĞµĞ½Ğ½Ğ¾Ğ¹ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğµ **Frontend - Backend - Database**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         FRONTEND                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  HTML5   â”‚  â”‚   CSS3   â”‚  â”‚     JavaScript           â”‚ â”‚
â”‚  â”‚  Pages   â”‚  â”‚  Styles  â”‚  â”‚  - Leaflet.js (ĞºĞ°Ñ€Ñ‚Ğ°)    â”‚ â”‚
â”‚  â”‚          â”‚  â”‚          â”‚  â”‚  - API Client            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  - Route Builder         â”‚ â”‚
â”‚                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“ HTTP/REST API (JSON)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         BACKEND                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              FastAPI Application                      â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚   Routes   â”‚  â”‚  Services  â”‚  â”‚    Models     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - auth    â”‚  â”‚  - auth    â”‚  â”‚   Pydantic    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - objects â”‚  â”‚  - route   â”‚  â”‚   Validation  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - routes  â”‚  â”‚            â”‚  â”‚               â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚         â†“              â†“                â†“            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚          Database Connection Pool              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚         mysql-connector-python                 â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“ SQL Queries
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        DATABASE                             â”‚
â”‚                      MySQL 8.x                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   heritage   â”‚  â”‚    users     â”‚  â”‚     routes       â”‚ â”‚
â”‚  â”‚   _objects   â”‚  â”‚              â”‚  â”‚                  â”‚ â”‚
â”‚  â”‚              â”‚  â”‚  - bcrypt    â”‚  â”‚  - start_point   â”‚ â”‚
â”‚  â”‚  - location  â”‚  â”‚    hashes    â”‚  â”‚  - POINT type    â”‚ â”‚
â”‚  â”‚  - POINT     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”‚  - SPATIAL   â”‚         â†“                    â†“           â”‚
â”‚  â”‚    INDEX     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚      route_objects (join)          â”‚ â”‚
â”‚                    â”‚  - sequence_number                  â”‚ â”‚
â”‚                    â”‚  - distance_from_previous           â”‚ â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—ï¸ ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹

### 1. Frontend Layer

**Ğ¢ĞµÑ…Ğ½Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ğ¸:** HTML5, CSS3, JavaScript (Vanilla), Leaflet.js

#### ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹:

##### 1.1. Pages (HTML)
- `index.html` - Ğ³Ğ»Ğ°Ğ²Ğ½Ğ°Ñ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° Ñ ĞºĞ°Ñ€Ñ‚Ğ¾Ğ¹
- `login.html` - ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° Ğ²Ñ…Ğ¾Ğ´Ğ°
- `register.html` - ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸

##### 1.2. Styles (CSS)
- `style.css` - ĞµĞ´Ğ¸Ğ½Ñ‹Ğ¹ Ñ„Ğ°Ğ¹Ğ» ÑÑ‚Ğ¸Ğ»ĞµĞ¹
  - ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹: header, sidebar, map, cards
  - Responsive Ğ´Ğ¸Ğ·Ğ°Ğ¹Ğ½ (Grid Layout)
  - ĞĞ½Ğ¸Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¸ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ñ‹

##### 1.3. JavaScript Modules

**`api.js`** - API Client
```javascript
class APIClient {
    - request()          // Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ HTTP ĞºĞ»Ğ¸ĞµĞ½Ñ‚
    - register()         // Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ
    - login()            // ĞĞ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
    - buildRoute()       // ĞŸĞ¾ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¸Ğµ Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ğ°
    - getObjects()       // ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ¾Ğ²
    - getRoutes()        // Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ğ¾Ğ²
}
```

**`map.js`** - Map Controller
```javascript
// Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ°Ñ€Ñ‚Ğ¾Ğ¹
- initMap()              // Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Leaflet
- onMapClick()           // ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ĞºĞ»Ğ¸ĞºĞ¾Ğ²
- setStartPoint()        // Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ñ‚Ğ¾Ñ‡ĞºĞ¸ ÑÑ‚Ğ°Ñ€Ñ‚Ğ°
- buildRoute()           // ĞŸĞ¾ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¸Ğµ Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ğ°
- displayRoute()         // ĞÑ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ Ğ½Ğ° ĞºĞ°Ñ€Ñ‚Ğµ
- reverseGeocode()       // Ğ“ĞµĞ¾ĞºĞ¾Ğ´Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
```

---

### 2. Backend Layer

**Ğ¢ĞµÑ…Ğ½Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ:** Python 3.10+, FastAPI

#### Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ°:

```
backend/
â”œâ”€â”€ main.py              # Ğ¢Ğ¾Ñ‡ĞºĞ° Ğ²Ñ…Ğ¾Ğ´Ğ°, FastAPI app
â”œâ”€â”€ config.py            # ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ (Settings)
â”œâ”€â”€ database.py          # ĞŸÑƒĞ» ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğ¹ MySQL
â”œâ”€â”€ models.py            # Pydantic Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸
â”œâ”€â”€ routes/              # API ÑĞ½Ğ´Ğ¿Ğ¾Ğ¸Ğ½Ñ‚Ñ‹
â”‚   â”œâ”€â”€ auth.py         # POST /api/register, /api/login
â”‚   â”œâ”€â”€ objects.py      # GET /api/objects
â”‚   â””â”€â”€ routes.py       # POST /api/route
â””â”€â”€ services/            # Ğ‘Ğ¸Ğ·Ğ½ĞµÑ-Ğ»Ğ¾Ğ³Ğ¸ĞºĞ°
    â”œâ”€â”€ auth_service.py  # ĞĞ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ, JWT
    â””â”€â”€ route_service.py # ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼ Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
```

#### 2.1. main.py - FastAPI Application

```python
app = FastAPI(
    title="Heritage Routes System",
    lifespan=lifespan  # Lifecycle ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ
)

# Middleware
app.add_middleware(CORSMiddleware)

# Routers
app.include_router(auth.router)
app.include_router(objects.router)
app.include_router(routes.router)

# Health check
@app.get("/health")
```

#### 2.2. database.py - Connection Pool

```python
# ĞŸÑƒĞ» ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğ¹ (10 ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğ¹)
connection_pool = pooling.MySQLConnectionPool(
    pool_name="heritage_pool",
    pool_size=10,
    host="localhost",
    user="root",
    ...
)

# ĞšĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ½Ñ‹Ğµ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ñ‹
@contextmanager
def get_db_cursor(dictionary=True):
    # ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸ÑĞ¼Ğ¸
    # commit/rollback
```

#### 2.3. models.py - Pydantic Models

```python
class RouteRequest(BaseModel):
    start_location: LocationPoint
    objects_count: int = Field(5, ge=2, le=20)
    
    @validator('start_location')
    def validate_moscow_coordinates(cls, v):
        # Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚ ĞœĞ¾ÑĞºĞ²Ñ‹
        ...

class RouteResponse(BaseModel):
    route_id: int
    objects: List[RouteObject]
    total_distance: float
    ...
```

#### 2.4. services/route_service.py - ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼

```python
def find_nearest_objects(lat, lon, limit, max_distance):
    """
    SQL Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ñ ST_Distance_Sphere
    SPATIAL INDEX Ğ´Ğ»Ñ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
    """
    query = """
    SELECT *, ST_Distance_Sphere(...) as distance
    FROM heritage_objects
    WHERE ST_Distance_Sphere(...) <= %s
    ORDER BY distance ASC
    LIMIT %s
    """

def build_greedy_route(start_lat, start_lon, objects):
    """
    Ğ–Ğ°Ğ´Ğ½Ñ‹Ğ¹ Ğ°Ğ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼ Ğ±Ğ»Ğ¸Ğ¶Ğ°Ğ¹ÑˆĞµĞ³Ğ¾ ÑĞ¾ÑĞµĞ´Ğ°:
    1. ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ñ Ñ‚Ğ¾Ñ‡ĞºĞ¸ ÑÑ‚Ğ°Ñ€Ñ‚Ğ°
    2. ĞĞ°Ğ¹Ñ‚Ğ¸ Ğ±Ğ»Ğ¸Ğ¶Ğ°Ğ¹ÑˆĞ¸Ğ¹ Ğ½ĞµĞ¿Ğ¾ÑĞµÑ‰Ñ‘Ğ½Ğ½Ñ‹Ğ¹ Ğ¾Ğ±ÑŠĞµĞºÑ‚
    3. ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚ÑŒ Ğ´Ğ¾ N Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ¾Ğ²
    """
    route = []
    remaining = objects.copy()
    current = (start_lat, start_lon)
    
    while remaining:
        nearest = find_nearest(current, remaining)
        route.append(nearest)
        remaining.remove(nearest)
        current = (nearest.lat, nearest.lon)
    
    return route
```

#### 2.5. services/auth_service.py - Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ

```python
# Ğ¥ÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ°Ñ€Ğ¾Ğ»ĞµĞ¹
pwd_context = CryptContext(
    schemes=["bcrypt"],
    deprecated="auto"
)

def hash_password(password: str) -> str:
    return pwd_context.hash(password)

def verify_password(plain, hashed) -> bool:
    return pwd_context.verify(plain, hashed)

# JWT Ñ‚Ğ¾ĞºĞµĞ½Ñ‹
def create_access_token(data: dict) -> str:
    payload = {**data, "exp": datetime.utcnow() + timedelta(hours=24)}
    return jwt.encode(payload, SECRET_KEY, algorithm="HS256")
```

---

### 3. Database Layer

**Ğ¢ĞµÑ…Ğ½Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ:** MySQL 8.x

#### 3.1. Ğ¡Ñ…ĞµĞ¼Ğ° Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

```sql
-- ĞĞ±ÑŠĞµĞºÑ‚Ñ‹ ĞºÑƒĞ»ÑŒÑ‚ÑƒÑ€Ğ½Ğ¾Ğ³Ğ¾ Ğ½Ğ°ÑĞ»ĞµĞ´Ğ¸Ñ
CREATE TABLE heritage_objects (
    id INT AUTO_INCREMENT PRIMARY KEY,
    global_id BIGINT UNIQUE NOT NULL,
    name VARCHAR(500) NOT NULL,
    address VARCHAR(500) NOT NULL,
    district VARCHAR(200),
    object_type VARCHAR(200),
    location POINT NOT NULL SRID 4326,  -- WGS84
    
    SPATIAL INDEX idx_location (location)
);

-- ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸
CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(100) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_username (username),
    INDEX idx_email (email)
);

-- ĞœĞ°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹
CREATE TABLE routes (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    start_location POINT NOT NULL SRID 4326,
    total_distance DECIMAL(10, 2),
    objects_count INT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (user_id) REFERENCES users(id),
    SPATIAL INDEX idx_start_location (start_location)
);

-- ĞĞ±ÑŠĞµĞºÑ‚Ñ‹ Ğ² Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ğµ
CREATE TABLE route_objects (
    id INT AUTO_INCREMENT PRIMARY KEY,
    route_id INT NOT NULL,
    object_id INT NOT NULL,
    sequence_number INT NOT NULL,
    distance_from_previous DECIMAL(10, 2),
    
    FOREIGN KEY (route_id) REFERENCES routes(id) ON DELETE CASCADE,
    FOREIGN KEY (object_id) REFERENCES heritage_objects(id),
    UNIQUE KEY (route_id, object_id)
);
```

#### 3.2. Spatial Ğ˜Ğ½Ğ´ĞµĞºÑÑ‹

**Ğ—Ğ°Ñ‡ĞµĞ¼:** Ğ£ÑĞºĞ¾Ñ€ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾ÑÑ‚Ñ€Ğ°Ğ½ÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²

**Ğ¢Ğ¸Ğ¿:** R-tree Ğ¸Ğ½Ğ´ĞµĞºÑ (Ğ´Ğ»Ñ POINT Ñ‚Ğ¸Ğ¿Ğ°)

**ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ:**
- Ğ‘ĞµĞ· Ğ¸Ğ½Ğ´ĞµĞºÑĞ°: O(n) - Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ¿ĞµÑ€ĞµĞ±Ğ¾Ñ€
- Ğ¡ Ğ¸Ğ½Ğ´ĞµĞºÑĞ¾Ğ¼: O(log n) - Ğ´Ñ€ĞµĞ²Ğ¾Ğ²Ğ¸Ğ´Ğ½Ñ‹Ğ¹ Ğ¿Ğ¾Ğ¸ÑĞº

**ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ:**
```sql
-- ĞŸĞ¾Ğ¸ÑĞº Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ¾Ğ² Ğ² Ñ€Ğ°Ğ´Ğ¸ÑƒÑĞµ 5 ĞºĞ¼
SELECT *
FROM heritage_objects
WHERE ST_Distance_Sphere(
    location,
    ST_GeomFromText('POINT(37.6208 55.7539)', 4326)
) <= 5000
ORDER BY ST_Distance_Sphere(...) ASC;

-- MySQL Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ SPATIAL INDEX Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸
-- Execution time: ~50ms Ğ´Ğ»Ñ 5000+ Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ¾Ğ²
```

---

## ğŸ”„ ĞŸĞ¾Ñ‚Ğ¾ĞºĞ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

### 1. ĞŸĞ¾ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¸Ğµ Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ğ°

```
User Action â†’ Frontend â†’ Backend â†’ Database â†’ Backend â†’ Frontend â†’ Map
    â†“            â†“          â†“          â†“          â†“          â†“        â†“
  Click      API Call   Route      Find       Build     JSON      Display
  on map     POST       Service    Objects    Route     Response   Route
             /route     
                        
Ğ”ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾:
1. User clicks on map
2. map.js: onMapClick(e) â†’ setStartPoint(lat, lng)
3. User clicks "ĞŸĞ¾ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚"
4. map.js: buildRoute() â†’ api.buildRoute()
5. api.js: fetch POST /api/route with JWT token
6. backend/routes/routes.py: create_route()
7. backend/services/route_service.py:
   - find_nearest_objects() â†’ MySQL query
   - build_greedy_route() â†’ algorithm
   - save_route_to_db() â†’ INSERT into routes
8. Response: RouteResponse JSON
9. map.js: displayRoute() â†’ Leaflet polyline + markers
10. User sees route on map
```

### 2. ĞĞ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ

```
User Login â†’ Frontend â†’ Backend â†’ Database â†’ Backend â†’ Frontend â†’ Storage
    â†“           â†“          â†“          â†“          â†“          â†“          â†“
  Submit     POST       Auth       Check      Create     Set        LocalStorage
  Form       /login     Service    User       JWT        Token      + Redirect
                        
Ğ”ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾:
1. User submits login form
2. api.js: login(username, password)
3. fetch POST /api/login
4. backend/routes/auth.py: login()
5. backend/services/auth_service.py:
   - get_user_by_username() â†’ SELECT from users
   - verify_password() â†’ bcrypt.verify()
   - create_access_token() â†’ jwt.encode()
6. Response: Token { access_token, user }
7. api.js: setToken(), setUser()
8. localStorage.setItem('auth_token', token)
9. Redirect to index.html
```

---

## âš¡ ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸

### 1. Database Optimizations

#### Spatial Ğ˜Ğ½Ğ´ĞµĞºÑÑ‹
- **Ğ¢Ğ¸Ğ¿:** R-tree Ğ´Ğ»Ñ POINT Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
- **Ğ­Ñ„Ñ„ĞµĞºÑ‚:** 100x ÑƒÑĞºĞ¾Ñ€ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ¸ÑĞºĞ°
- **Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ:** Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ğ¿Ñ€Ğ¸ ST_Distance_Sphere

#### Connection Pool
```python
# ĞŸÑƒĞ» Ğ¸Ğ· 10 ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğ¹
# ĞŸĞµÑ€ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğ¹
# Ğ˜Ğ·Ğ±ĞµĞ³Ğ°ĞµĞ¼ overhead ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ/Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ
connection_pool = MySQLConnectionPool(pool_size=10)
```

#### Prepared Statements
```python
# Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ SQL injection + ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ»Ğ°Ğ½Ğ° Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°
cursor.execute(
    "SELECT * FROM heritage_objects WHERE id = %s",
    (object_id,)
)
```

### 2. Backend Optimizations

#### Async IO (FastAPI)
```python
# ĞĞµĞ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒÑÑ‰Ğ¸Ğµ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸
# ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¼Ğ½Ğ¾Ğ¶ĞµÑÑ‚Ğ²Ğ° Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğ¾Ğ´Ğ½Ğ¾Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾
@app.post("/api/route")
async def create_route(...):
    # Async operations
```

#### Request Validation (Pydantic)
```python
# ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ğ²Ñ…Ğ¾Ğ´Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
# ĞĞµÑ‚ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ² Ñ€ÑƒÑ‡Ğ½Ñ‹Ñ… Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°Ñ…
class RouteRequest(BaseModel):
    objects_count: int = Field(ge=2, le=20)
```

### 3. Frontend Optimizations

#### Leaflet Clustering
```javascript
// Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ±Ğ»Ğ¸Ğ·ĞºĞ¸Ñ… Ğ¼Ğ°Ñ€ĞºĞµÑ€Ğ¾Ğ²
// ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ğ¿Ñ€Ğ¸ Ğ±Ğ¾Ğ»ÑŒÑˆĞ¾Ğ¼ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğµ Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ¾Ğ²
const markers = L.markerClusterGroup();
```

#### Local Storage
```javascript
// ĞšÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ‚Ğ¾ĞºĞµĞ½Ğ° Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
// Ğ˜Ğ·Ğ±ĞµĞ³Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğ½Ğ° /me
localStorage.setItem('auth_token', token);
```

---

## ğŸ›¡ï¸ Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ

### 1. ĞÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ

#### JWT Tokens
- **ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼:** HS256 (HMAC with SHA-256)
- **Ğ¡Ñ€Ğ¾Ğº Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ:** 24 Ñ‡Ğ°ÑĞ°
- **Payload:** { user_id, exp }

#### Password Hashing
- **ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼:** bcrypt
- **Rounds:** 12 (Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ)
- **Salt:** Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ

### 2. Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ Ğ°Ñ‚Ğ°Ğº

#### SQL Injection
```python
# âœ… ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾ (Prepared Statements)
cursor.execute("SELECT * FROM users WHERE id = %s", (user_id,))

# âŒ ĞĞµĞ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾ (String Concatenation)
cursor.execute(f"SELECT * FROM users WHERE id = {user_id}")
```

#### XSS (Cross-Site Scripting)
```javascript
// âœ… ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾ (textContent)
element.textContent = userInput;

// âŒ ĞĞµĞ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾ (innerHTML Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒÑĞºĞ¸Ğ¼ Ğ²Ğ²Ğ¾Ğ´Ğ¾Ğ¼)
element.innerHTML = userInput;
```

#### CSRF
- Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ JWT Ğ² Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ°Ñ… (Ğ½Ğµ cookies)
- CORS Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½ Ğ´Ğ»Ñ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ñ… origin

---

## ğŸ“Š ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ

### ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸

| ĞĞ¿ĞµÑ€Ğ°Ñ†Ğ¸Ñ | Ğ’Ñ€ĞµĞ¼Ñ | ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ |
|----------|-------|-------------|
| ĞŸĞ¾Ğ¸ÑĞº 10 Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ¾Ğ² | ~50ms | SPATIAL INDEX |
| ĞŸĞ¾ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¸Ğµ Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ğ° | ~100ms | Ğ–Ğ°Ğ´Ğ½Ñ‹Ğ¹ Ğ°Ğ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼ O(nÂ²) |
| Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ | ~200ms | bcrypt hashing |
| Ğ’Ñ…Ğ¾Ğ´ | ~150ms | bcrypt verify |
| Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ĞºĞ°Ñ€Ñ‚Ñ‹ | ~1s | CDN (Leaflet, OSM) |

### ĞœĞ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€ÑƒĞµĞ¼Ğ¾ÑÑ‚ÑŒ

- **ĞĞ±ÑŠĞµĞºÑ‚Ñ‹ Ğ² Ğ‘Ğ”:** 5000+ (Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾)
- **ĞœĞ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ¾Ğ²:** 100,000+ (Ñ Ğ¸Ğ½Ğ´ĞµĞºÑĞ°Ğ¼Ğ¸)
- **Concurrent users:** 100+ (FastAPI + Connection Pool)

---

## ğŸ”® Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ñ‹Ğµ ÑƒĞ»ÑƒÑ‡ÑˆĞµĞ½Ğ¸Ñ

### 1. ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼
- Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ A* Ğ¸Ğ»Ğ¸ Dijkstra Ğ´Ğ»Ñ Ğ±Ğ¾Ğ»ĞµĞµ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ğ¾Ğ²
- Ğ£Ñ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ğ²Ñ€ĞµĞ¼Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ¾Ğ²
- Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ preference Ğ¿Ğ¾ Ñ‚Ğ¸Ğ¿Ğ°Ğ¼ Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ¾Ğ²

### 2. ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ
- Redis Ğ´Ğ»Ñ ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ğ¾Ğ²
- CDN Ğ´Ğ»Ñ ÑÑ‚Ğ°Ñ‚Ğ¸ĞºĞ¸
- Gzip compression

### 3. Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ
- Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ğ¾Ğ² (GPX, KML)
- ĞÑ„Ñ„Ğ»Ğ°Ğ¹Ğ½ Ñ€ĞµĞ¶Ğ¸Ğ¼ (PWA)
- Push ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ
- Ğ¡Ğ¾Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸

---

## ğŸ“ Ğ¢Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğº Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ

### ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ
- CPU: 2 cores
- RAM: 4 GB
- HDD: 10 GB
- Python 3.10+
- MySQL 8.0+

### Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµĞ¼Ñ‹Ğµ
- CPU: 4 cores
- RAM: 8 GB
- SSD: 20 GB
- Python 3.11+
- MySQL 8.2+

